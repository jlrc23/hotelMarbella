window.CMB=function(e,t,i){"use strict";var n=e.cmb_l10,s=e.setTimeout,a={formfield:"",idNumber:!1,file_frames:{},repeatEls:'input:not([type="button"]),select,textarea,.cmb_media_status'};return a.metabox=function(){return a.$metabox?a.$metabox:(a.$metabox=i("table.cmb_metabox"),a.$metabox)},a.init=function(){var t=a.metabox(),r=t.find(".repeatable-group");n.new_admin_style&&t.find(".cmb-spinner img").hide(),a.initPickers(t.find("input:text.cmb_timepicker"),t.find("input:text.cmb_datepicker"),t.find("input:text.cmb_colorpicker")),i("#ui-datepicker-div").wrap('<div class="cmb_element" />'),i('<p><span class="button cmb-multicheck-toggle">'+n.check_toggle+"</span></p>").insertBefore("ul.cmb_checkbox_list"),t.on("change",".cmb_upload_file",function(){a.formfield=i(this).attr("id"),i("#"+a.formfield+"_id").val("")}).on("click",".cmb-multicheck-toggle",a.toggleCheckBoxes).on("click",".cmb_upload_button",a.handleMedia).on("click",".cmb_remove_file_button",a.handleRemoveMedia).on("click",".add-group-row",a.addGroupRow).on("click",".add-row-button",a.addAjaxRow).on("click",".remove-group-row",a.removeGroupRow).on("click",".remove-row-button",a.removeAjaxRow).on("keyup paste focusout",".cmb_oembed",a.maybeOembed).on("cmb_remove_row",".repeatable-group",a.resetTitlesAndIterator),r.length&&r.filter(".sortable").each(function(){i(this).find(".remove-group-row").before('<a class="shift-rows move-up alignleft" href="#">'+n.up_arrow+'</a> <a class="shift-rows move-down alignleft" href="#">'+n.down_arrow+"</a>")}).on("click",".shift-rows",a.shiftRows).on("cmb_add_row",a.emptyValue),s(a.resizeoEmbeds,500),i(e).on("resize",a.resizeoEmbeds)},a.resetTitlesAndIterator=function(){i(".repeatable-group").each(function(){var e=i(this);e.find(".repeatable-grouping").each(function(t){var n=i(this);n.data("iterator",t),n.find(".cmb-group-title h4").text(e.find(".add-group-row").data("grouptitle").replace("{#}",t+1))})})},a.toggleCheckBoxes=function(e){e.preventDefault();var t=i(this),n=t.parents("td").find("input[type=checkbox]");t.data("checked")?(n.prop("checked",!1),t.data("checked",!1)):(n.prop("checked",!0),t.data("checked",!0))},a.handleMedia=function(e){if(wp){e.preventDefault();var t=a.metabox(),s=i(this);a.formfield=s.prev("input").attr("id");var r=i("#"+a.formfield),o=r.attr("name"),l=!0,c=!0,u=s.hasClass("cmb_upload_list");if(a.formfield in a.file_frames)return a.file_frames[a.formfield].open(),void 0;a.file_frames[a.formfield]=wp.media.frames.file_frame=wp.media({title:t.find("label[for="+a.formfield+"]").text(),button:{text:n.upload_file},multiple:u?!0:!1});var h={list:function(e){c=e.toJSON(),r.val(c.url),i("#"+a.formfield+"_id").val(c.id);var t=[];i(c).each(function(){l=this.type&&"image"===this.type?'<li class="img_status"><img width="50" height="50" src="'+this.url+'" class="attachment-50x50" alt="'+this.filename+'">'+'<p><a href="#" class="cmb_remove_file_button" rel="'+a.formfield+"["+this.id+']">'+n.remove_image+"</a></p>"+'<input type="hidden" id="filelist-'+this.id+'" name="'+o+"["+this.id+']" value="'+this.url+'">'+"</li>":"<li>"+n.file+" <strong>"+this.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+n.download+'</a> / <a href="#" class="cmb_remove_file_button" rel="'+a.formfield+"["+this.id+']">'+n.remove_file+"</a>)"+'<input type="hidden" id="filelist-'+this.id+'" name="'+o+"["+this.id+']" value="'+this.url+'">'+"</li>",t.push(l)}),i(t).each(function(){r.siblings(".cmb_media_status").slideDown().append(this)})},single:function(e){c=e.first().toJSON(),r.val(c.url),i("#"+a.formfield+"_id").val(c.id),l=c.type&&"image"===c.type?'<div class="img_status"><img style="max-width: 350px; width: 100%; height: auto;" src="'+c.url+'" alt="'+c.filename+'" title="'+c.filename+'" /><p><a href="#" class="cmb_remove_file_button" rel="'+a.formfield+'">'+n.remove_image+"</a></p></div>":n.file+" <strong>"+c.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+c.url+'" target="_blank" rel="external">'+n.download+'</a> / <a href="#" class="cmb_remove_file_button" rel="'+a.formfield+'">'+n.remove_file+"</a>)",r.siblings(".cmb_media_status").slideDown().html(l)}};a.file_frames[a.formfield].on("select",function(){var e=a.file_frames[a.formfield].state().get("selection"),t=u?"list":"single";h[t](e)}),a.file_frames[a.formfield].open()}},a.handleRemoveMedia=function(e){e.preventDefault();var t=i(this);if(t.is(".attach_list .cmb_remove_file_button"))return t.parents("li").remove(),!1;a.formfield=t.attr("rel");var n=t.parents(".img_status");return a.metabox().find("input#"+a.formfield).val(""),a.metabox().find("input#"+a.formfield+"_id").val(""),n.length?n.html(""):t.parents(".cmb_media_status").html(""),!1},i.fn.replaceText=function(e,t,n){return this.each(function(){var s,a,r=this.firstChild,o=[];if(r)do 3===r.nodeType&&(s=r.nodeValue,a=s.replace(e,t),a!==s&&(!n&&/</.test(a)?(i(r).before(a),o.push(r)):r.nodeValue=a));while(r=r.nextSibling);o.length&&i(o).remove()})},i.fn.cleanRow=function(e,t){var n=i(this),s=n.find('input:not([type="button"]), select, textarea, label');return t&&n.find(".cmb-repeat-table .repeat-row:not(:first-child)").remove(),a.$focus=!1,a.neweditor_id=[],s.filter(":checked").removeAttr("checked"),s.filter(":selected").removeAttr("selected"),n.find(".cmb-group-title")&&n.find(".cmb-group-title h4").text(n.data("title").replace("{#}",a.idNumber+1)),s.each(function(){var t,n,s=i(this),r=s.hasClass("wp-editor-area"),o=s.attr("for"),l={};if(o)l={"for":o.replace("_"+e,"_"+a.idNumber)};else{var c=s.attr("name"),u=c?c.replace("["+e+"]","["+a.idNumber+"]"):"";n=s.attr("id"),t=n?n.replace("_"+e,"_"+a.idNumber):"",l={id:t,name:u,"data-iterator":a.idNumber}}if(s.removeClass("hasDatepicker").attr(l).val(""),r){t=t?n.replace("zx"+e,"zx"+a.idNumber):"",s.html("");var h=s.parents(".cmb-type-wysiwyg");h.find(".mce-tinymce:not(:first-child)").remove();var d=h.html().replace(new RegExp(n,"g"),t);h.html(d),a.neweditor_id.push({id:t,old:n})}a.$focus=a.$focus?a.$focus:s}),this},i.fn.newRowHousekeeping=function(){var e=i(this),t=e.find(".wp-picker-container"),n=e.find(".cmb_media_status");return t.length&&t.each(function(){var e=i(this).parent();e.html(e.find("input:text.cmb_colorpicker").attr("style",""))}),n.length&&n.empty(),this},a.afterRowInsert=function(e){a.$focus&&a.$focus.focus();var t;if(a.neweditor_id.length){var i;for(i=a.neweditor_id.length-1;i>=0;i--){var n=a.neweditor_id[i].id,s=a.neweditor_id[i].old;if("undefined"==typeof tinyMCEPreInit.mceInit[n]){var r=jQuery.extend({},tinyMCEPreInit.mceInit[s]);for(t in r)"string"==typeof r[t]&&(r[t]=r[t].replace(new RegExp(s,"g"),n));tinyMCEPreInit.mceInit[n]=r}if("undefined"==typeof tinyMCEPreInit.qtInit[n]){var o=jQuery.extend({},tinyMCEPreInit.qtInit[s]);for(t in o)"string"==typeof o[t]&&(o[t]=o[t].replace(new RegExp(s,"g"),n));tinyMCEPreInit.qtInit[n]=o}tinyMCE.init({id:tinyMCEPreInit.mceInit[n]})}}a.initPickers(e.find("input:text.cmb_timepicker"),e.find("input:text.cmb_datepicker"),e.find("input:text.cmb_colorpicker"))},a.updateNameAttr=function(){var e=i(this),t=e.attr("name");if("undefined"==typeof t)return!1;var n=parseInt(e.parents(".repeatable-grouping").data("iterator")),s=n-1,a=t.replace("["+n+"]","["+s+"]");e.attr("name",a)},a.emptyValue=function(e,t){i('input:not([type="button"]), textarea',t).val("")},a.addGroupRow=function(e){e.preventDefault();var t=i(this),n=i("#"+t.data("selector")),s=n.find(".repeatable-grouping").last(),r=parseInt(s.data("iterator"));a.idNumber=r+1;var o=s.clone();o.data("title",t.data("grouptitle")).newRowHousekeeping().cleanRow(r,!0);var l=i('<tr class="repeatable-grouping" data-iterator="'+a.idNumber+'">'+o.html()+"</tr>");s.after(l),a.afterRowInsert(l),n.find(".repeatable-grouping").length<=1?n.find(".remove-group-row").prop("disabled",!0):n.find(".remove-group-row").removeAttr("disabled"),n.trigger("cmb_add_row",l)},a.addAjaxRow=function(e){e.preventDefault();var t=i(this),n="#"+t.data("selector"),s=i(n),r=s.find(".empty-row"),o=parseInt(r.find("[data-iterator]").data("iterator"));a.idNumber=o+1;var l=r.clone();l.newRowHousekeeping().cleanRow(o),r.removeClass("empty-row").addClass("repeat-row"),r.after(l),a.afterRowInsert(l),s.trigger("cmb_add_row",l)},a.removeGroupRow=function(e){e.preventDefault();var t=i(this),n=i("#"+t.data("selector")),s=t.parents(".repeatable-grouping"),r=n.find(".repeatable-grouping").length;s.nextAll(".repeatable-grouping").find(a.repeatEls).each(a.updateNameAttr),r>1&&(s.remove(),3>r?n.find(".remove-group-row").prop("disabled",!0):n.find(".remove-group-row").prop("disabled",!1),n.trigger("cmb_remove_row"))},a.removeAjaxRow=function(e){e.preventDefault();var t=i(this),n=t.parents("tr"),s=t.parents(".cmb-repeat-table");s.find("tr").length>1&&(n.hasClass("empty-row")&&n.prev().addClass("empty-row").removeClass("repeat-row"),t.parents(".cmb-repeat-table tr").remove(),s.trigger("cmb_remove_row"))},a.shiftRows=function(e){e.preventDefault();var t=i(this),n=t.parents(".repeatable-grouping"),s=t.hasClass("move-up")?n.prev(".repeatable-grouping"):n.next(".repeatable-grouping");if(s.length){var r=[];n.find(a.repeatEls).each(function(){var e,t=i(this);t.hasClass("cmb_media_status")?e=t.html():"checkbox"===t.attr("type")?(e=t.is(":checked"),a.log("checked",e)):"select"===t.prop("tagName")?(e=t.is(":selected"),a.log("checked",e)):e=t.val(),r.push({val:e,$:t})}),s.find(a.repeatEls).each(function(e){var t,n=i(this);n.hasClass("cmb_media_status")?(t=n.html(),n.html(r[e].val),r[e].$.html(t)):"checkbox"===n.attr("type")?(r[e].$.prop("checked",n.is(":checked")),n.prop("checked",r[e].val)):"select"===n.prop("tagName")?(r[e].$.prop("selected",n.is(":selected")),n.prop("selected",r[e].val)):(r[e].$.val(n.val()),n.val(r[e].val))})}},a.initPickers=function(e,t,i){a.initTimePickers(e),a.initDatePickers(t),a.initColorPickers(i)},a.initTimePickers=function(e){e.length&&e.timePicker({startTime:"00:00",endTime:"23:59",show24Hours:!1,separator:":",step:30})},a.initDatePickers=function(e){e.length&&(e.datepicker("destroy"),e.datepicker())},a.initColorPickers=function(e){e.length&&("object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker?e.wpColorPicker():e.each(function(e){i(this).after('<div id="picker-'+e+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>'),i("#picker-"+e).hide().farbtastic(i(this))}).focus(function(){i(this).next().show()}).blur(function(){i(this).next().hide()}))},a.maybeOembed=function(e){var t=i(this),n=e.type,r={focusout:function(){s(function(){a.spinner(".postbox table.cmb_metabox",!0)},2e3)},keyup:function(){var i=function(t,i){return e.which<=i&&e.which>=t};(i(48,90)||i(96,111)||i(8,9)||187===e.which||190===e.which)&&a.doAjax(t,e)},paste:function(){s(function(){a.doAjax(t)},100)}};r[n]()},a.resizeoEmbeds=function(){a.metabox().each(function(){var e=i(this),t=e.parents(".inside");if(!t.length)return!0;var n=Math.round(.97*.82*t.width())-30;if(n>639)return!0;var s=e.find(".cmb-type-oembed .embed_status"),a=s.children().not(".cmb_remove_wrapper");return a.length?(a.each(function(){var e=i(this),t=e.width(),s=e.height(),a=n;e.parents(".repeat-row").length&&(a=n-91);var r=Math.round(a*s/t);e.width(a).height(r)}),void 0):!0})},a.log=function(){n.script_debug&&console&&"function"==typeof console.log&&console.log.apply(console,arguments)},a.spinner=function(e,t){t?i(".cmb-spinner",e).hide():i(".cmb-spinner",e).show()},a.doAjax=function(e){var t=e.val();if(!(t.length<6)){var r=e.attr("id"),o=e.parents(".cmb-repeat-table  tr td");o=o.length?o:e.parents(".cmb_metabox tr td");var l=i(".embed_status",o),c=e.width(),u=i(":first-child",l);a.log("oembed_url",t,r),c=l.length&&u.length?u.width():e.width(),a.spinner(o),i(".embed_wrap",o).html(""),s(function(){i(".cmb_oembed:focus").val()===t&&i.ajax({type:"post",dataType:"json",url:n.ajaxurl,data:{action:"cmb_oembed_handler",oembed_url:t,oembed_width:c>300?c:300,field_id:r,object_id:e.data("objectid"),object_type:e.data("objecttype"),cmb_ajax_nonce:n.ajax_nonce},success:function(e){a.log(e),"undefined"!=typeof e.id&&(a.spinner(o,!0),i(".embed_wrap",o).html(e.result))}})},500)}},i(t).ready(a.init),a}(window,document,jQuery);